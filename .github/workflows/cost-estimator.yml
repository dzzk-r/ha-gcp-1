name: Terraform Cost Estimation

on:
  workflow_dispatch:
  pull_request:

permissions:
  contents: read

jobs:
  cost-estimation:
    name: Estimate Terraform Costs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: latest

      - name: Initialize Terraform
        run: terraform init -reconfigure # Ensures backend is properly initialized

      - name: Generate Terraform Plan
        run: terraform plan -out=tfplan

      - name: Install Infracost
        run: |
          curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
          infracost --version

      - name: Generate Terraform Cost Estimate
        run: |
          infracost breakdown --path . --format json > cost-report.json
#          terraform init -backend=false # No GCP required
#          terraform plan -out=tfplan

      - name: Show Cost Report
        run: cat cost-report.json
