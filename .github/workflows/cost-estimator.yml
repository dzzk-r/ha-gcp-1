name: Terraform Cost Estimation

on:
  workflow_dispatch:
  pull_request:

permissions:
  contents: read

env:
  ACTIONS_RUNNER_DEBUG: true
  ACTIONS_STEP_DEBUG: true

jobs:
  cost-estimation:
    name: Estimate Terraform Costs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: latest

      - name: Initialize Terraform
        run: terraform init -reconfigure

      - name: Install Infracost
        run: |
          curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
          infracost --version

      - name: Set Infracost API Key
        run: echo "INFRACOST_API_KEY=${{ secrets.INFRACOST_API_KEY }}" >> $GITHUB_ENV

      - name: Generate Terraform Plan (Fake Mode)
        run: |
          echo "Generating fake Terraform plan..."
          echo '{"format_version":"0.1","terraform_version":"1.0.0","planned_values":{"root_module":{}}}' > tfplan.json

      - name: Debug - Show Terraform Plan JSON
        run: |
          terraform show -json tfplan > tfplan.json || echo "{}" > tfplan.json
          cat tfplan.json | jq .

      - name: Generate Cost Estimate
        run: |
          echo "Running infracost breakdown..."
          infracost breakdown \
            --usage-file infracost-usage.yaml \ # FAKE estimated pricing instead of returning priceNotFound errors
            --sync-usage-file infracost-usage.yaml
            --path . \
            --format json \
            --out-file=cost-report.json || echo "{}" > cost-report.json
#            --usage-file infracost-usage.yaml \ # FAKE estimated pricing instead of returning priceNotFound errors

          echo "Verifying cost-report.json..."
          ls -lah cost-report.json || echo "{}" > cost-report.json
          
          echo "Final cost-report.json contents:"
          cat cost-report.json | jq .

      - name: Upload Cost Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: infracost-report
          path: cost-report.json
          retention-days: 7

      - name: Show Cost Report
        run: cat cost-report.json

      - name: Download Cost Report Artifact (Ensure Persistence)
        uses: actions/download-artifact@v4
        with:
          name: infracost-report
          path: .

      - name: Debug - Check Available Files
        run: |
          echo "Checking available files in workspace..."
          ls -lah

      - name: Post Infracost Comment
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          if [ ! -f cost-report.json ]; then
            echo "No cost report found, skipping comment."
            exit 0
          fi
          
          PR_NUMBER="${{ github.event.pull_request.number || '' }}"
          
          if [[ -n "$PR_NUMBER" ]]; then
            echo "Posting cost estimate comment to PR #$PR_NUMBER"
            infracost comment github --path=cost-report.json \
                                     --repo=$GITHUB_REPOSITORY \
                                     --github-token=${{ secrets.GH_PAT }} \
                                     --pull-request="$PR_NUMBER" \
                                     --behavior=update
          else
            echo "Manual run detected. Posting cost report to latest commit: ${{ github.sha }}"
            infracost comment github --path=cost-report.json \
                                     --repo=$GITHUB_REPOSITORY \
                                     --github-token=${{ secrets.GH_PAT }} \
                                     --commit=${{ github.sha }} \
                                     --behavior=update
          fi
