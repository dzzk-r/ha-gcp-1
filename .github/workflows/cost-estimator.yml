name: Terraform Cost Estimation

on:
  workflow_dispatch:
  pull_request:

permissions:
  contents: read

env:
  ACTIONS_RUNNER_DEBUG: true
  ACTIONS_STEP_DEBUG: true

jobs:
  cost-estimation:
    name: Estimate Terraform Costs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: latest

      - name: Initialize Terraform
        run: terraform init -reconfigure

      - name: Generate Fake Terraform Plan (No Real GCP)
        run: |
          echo "Creating fake Terraform plan..."
          touch tfplan
          echo "Fake Terraform Plan - No GCP" > tfplan

      - name: Install Infracost
        run: |
          curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
          infracost --version

      - name: Set Infracost API Key
        run: echo "INFRACOST_API_KEY=${{ secrets.INFRACOST_API_KEY }}" >> $GITHUB_ENV

      - name: Force Generate Cost Estimate (Bypassing Terraform Plan)
        run: |
          echo "Running infracost breakdown with fake values..."
          
          infracost breakdown --path . --format json --out-file=cost-report.json --log-level=debug || echo "{}" > cost-report.json

          echo "Verifying cost-report.json..."
          ls -lah cost-report.json || echo "{}" > cost-report.json

          echo "Final cost-report.json contents:"
          cat cost-report.json | jq .

      - name: Upload Cost Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: infracost-report
          path: cost-report.json
          retention-days: 7

      - name: Show Cost Report
        run: cat cost-report.json

      - name: Download Cost Report Artifact (Ensure Persistence)
        uses: actions/download-artifact@v4
        with:
          name: infracost-report
          path: .

      - name: Debug - Check Available Files
        run: |
          echo "Checking available files in workspace..."
          ls -lah

      - name: Post Infracost Comment
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          echo "Checking if cost-report.json exists..."
          ls -lah

          if [ ! -f cost-report.json ]; then
            echo "cost-report.json is missing! Copying from artifacts if available..."
            cp infracost-latest.json cost-report.json || echo "{}" > cost-report.json
          fi

          # Ensure JSON file is valid before posting
          jq empty cost-report.json || { echo "Invalid JSON file! Fixing..."; echo "{}" > cost-report.json; }

          # Exit if cost-report.json is still empty
          if [ ! -s cost-report.json ]; then
            echo "No cost report found, skipping comment."
            exit 0
          fi

          PR_NUMBER="${{ github.event.pull_request.number || '' }}"

          if [[ -n "$PR_NUMBER" ]]; then
            echo "Posting cost estimate comment to PR #$PR_NUMBER"
            infracost comment github --path=cost-report.json \
                                     --repo=$GITHUB_REPOSITORY \
                                     --github-token=${{ secrets.GH_PAT }} \
                                     --pull-request="$PR_NUMBER" \
                                     --behavior=update
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Manual run detected. Posting cost report to latest commit: ${{ github.sha }}"
            infracost comment github --path=cost-report.json \
                                     --repo=$GITHUB_REPOSITORY \
                                     --github-token=${{ secrets.GH_PAT }} \
                                     --commit=${{ github.sha }} \
                                     --behavior=update
          else
            echo "No valid context (PR or Manual Trigger) for Infracost comment, skipping..."
          fi
