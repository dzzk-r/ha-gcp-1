name: Terraform CI/CD

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: write

jobs:
  setup:
    name: Setup & Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Cache Terraform Dependencies
        uses: actions/cache@v4
        with:
          path: .terraform/
          key: terraform-${{ runner.os }}-${{ hashFiles('**/*.tf') }}
          restore-keys: terraform-${{ runner.os }}-

  terraform-tasks:
    name: Parallel Terraform Tasks
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task: [validate, security-scan, cost-estimation]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        if: matrix.task != 'security-scan'
        run: terraform init -reconfigure

      - name: Terraform Validate
        if: matrix.task == 'validate'
        run: terraform validate -no-color

      - name: Install Checkov
        if: matrix.task == 'security-scan'
        run: pip install checkov

      - name: Run Checkov Security Scan
        if: matrix.task == 'security-scan'
        run: |
          checkov -d . --quiet --output json > checkov-report.json || true
          cat checkov-report.json | jq . > checkov-results.json

      - name: Install Infracost
        if: matrix.task == 'cost-estimation'
        run: |
          curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh

      - name: Run Infracost Estimate
        if: matrix.task == 'cost-estimation'
        run: |
          infracost breakdown --path . --format json > infracost.json || true
          cat infracost.json | jq . > infracost-results.json

      - name: Save Task Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.task }}-report
          path: |
            checkov-results.json
            infracost-results.json
            tfplan.json
          if-no-files-found: ignore

  terraform-apply:
    name: Terraform Apply (Main Branch Only)
    needs: terraform-tasks
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        run: terraform init -reconfigure

      - name: Terraform Apply
        run: terraform apply -auto-approve
