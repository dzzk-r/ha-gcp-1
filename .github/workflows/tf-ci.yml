name: Terraform CI

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

jobs:
  terraform:
    name: Terraform Validation & Security Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.5

      - name: Terraform Format Check
        run: terraform fmt -recursive -check

      - name: Generate Fake GCP Credentials
        run: |
          echo "Generating fake GCP credentials..."
          cat > fake-gcp-credentials.json <<EOL
          {
            "type": "service_account",
            "project_id": "mock-project",
            "private_key_id": "mock-key",
            "private_key": "-----BEGIN PRIVATE KEY-----\nmock-key-data\n-----END PRIVATE KEY-----\n",
            "client_email": "mock-sa@mock-project.iam.gserviceaccount.com",
            "client_id": "mock-client-id",
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token",
            "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
            "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/mock-sa@mock-project.iam.gserviceaccount.com"
          }
          EOL

      - name: Verify Fake GCP Credentials
        run: |
          echo "Checking fake GCP credentials..."
          if ! jq -e '.type' fake-gcp-credentials.json > /dev/null; then
            echo "Error: 'type' field is missing in fake-gcp-credentials.json!"
            exit 1
          fi
          echo "Setting GOOGLE_APPLICATION_CREDENTIALS..."
          echo "FAKE_CREDENTIALS=$(pwd)/fake-gcp-credentials.json" >> $GITHUB_ENV

      - name: Debug - Show Fake GCP Credentials
        run: cat fake-gcp-credentials.json | jq .

      - name: Terraform Init (No Backend, Ensure Clean State)
        run: |
          echo "Cleaning any existing Terraform state..."
          rm -rf .terraform terraform.tfstate* tfplan* || true
          
          echo "Checking for backend in configuration..."
          if grep -Ri "backend" . | grep -vE '^\s*#'; then
            echo "⚠️ Backend detected! Ensure backend is disabled in 'main.tf'."
            exit 1
          fi
          
          echo "Initializing Terraform without backend..."
          terraform init -backend=false -reconfigure -force-copy

      - name: Terraform Validate
        run: terraform validate -no-color

      - name: Generate Terraform Plan (Mocked GCP)
        run: |
          echo "Setting up Fake Credentials for Terraform..."
          export GOOGLE_APPLICATION_CREDENTIALS="${FAKE_CREDENTIALS}"
          
          echo "Cleaning Terraform state..."
          rm -rf .terraform terraform.tfstate* tfplan* || true
          
          echo "Initializing Terraform..."
          terraform init -backend=false -reconfigure || { echo "Terraform Init failed!"; exit 1; }
          
          echo "Generating Terraform plan..."
          terraform plan -input=false -var="project_id=mock-project" -var="region=mock-region" -out=tfplan.binary || { echo "Terraform Plan failed!"; exit 1; }

      - name: Validate Terraform Plan JSON
        run: |
          if ! jq empty tfplan.json; then
            echo "Error: tfplan.json is not valid JSON!"
            exit 1
          fi

      - name: Save Terraform Plan JSON
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: tfplan.json

      - name: Install Checkov (Security Scan)
        run: pip install checkov

      - name: Run Checkov Security Scan
        run: |
          checkov -d . --quiet --output json > checkov-report.json || true

      - name: Save Checkov Report
        uses: actions/upload-artifact@v4
        with:
          name: checkov-report
          path: checkov-report.json
