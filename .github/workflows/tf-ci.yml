name: Terraform CI/CD

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

jobs:
  setup:
    name: Setup & Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Cache Terraform Dependencies
        uses: actions/cache@v4
        with:
          path: .terraform/
          key: terraform-${{ runner.os }}-${{ hashFiles('**/*.tf') }}
          restore-keys: terraform-${{ runner.os }}-

  terraform-tasks:
    name: Parallel Terraform Tasks
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task: [validate, security-scan, cost-estimation]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Terraform Init
        if: matrix.task != 'security-scan'
        run: terraform init -reconfigure

      - name: Terraform Validate
        if: matrix.task == 'validate'
        run: terraform validate -no-color

      - name: Install Checkov
        if: matrix.task == 'security-scan'
        run: pip install checkov

      - name: Run Checkov Security Scan
        if: matrix.task == 'security-scan'
        run: checkov -d . --quiet --output json > checkov-report.json || true

      - name: Install Infracost
        if: matrix.task == 'cost-estimation'
        run: |
          curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh

      - name: Run Infracost Estimate
        if: matrix.task == 'cost-estimation'
        run: |
          infracost breakdown --path . --format json > infracost.json || true

      - name: Save Task Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.task }}-report
          path: |
            checkov-report.json
            infracost.json
            tfplan.json
          if-no-files-found: ignore

  terraform-plan:
    name: Terraform Plan
    needs: terraform-tasks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Terraform Init
        run: terraform init -reconfigure

      - name: Generate Terraform Plan
        run: terraform plan -input=false -var="project_id=mock-project" -var="region=mock-region" -out=tfplan.binary || echo "No changes detected"

      - name: Convert Plan to JSON
        run: terraform show -json tfplan.binary > tfplan.json || echo "{}" > tfplan.json

      - name: Save Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: tfplan.json

      - name: Post Terraform Plan to PR
        if: github.event_name == 'pull_request'
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            ðŸš€ **Terraform Plan Results**:
            ```
            $(terraform show tfplan.binary)
            ```
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Post Infracost Report to PR
        if: github.event_name == 'pull_request'
        run: |
          echo "### :moneybag: Estimated Cost Changes" >> infracost-comment.txt
          echo '```json' >> infracost-comment.txt
          cat infracost.json >> infracost-comment.txt
          echo '```' >> infracost-comment.txt
          gh pr comment ${{ github.event.pull_request.number }} -F infracost-comment.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  terraform-apply:
    name: Terraform Apply (Main Only)
    needs: terraform-plan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Terraform Apply
        run: terraform apply -auto-approve
